# redis

## redis是单线程的么？

redis在后台进行进行处理的时候，确实是一个线程进行相关的操作，但是后台还是有很很多其他县城，比如用一个关闭文件（缓存fush到硬盘上）的线程，AOF刷盘的线程，因为这些任务都比较慢，而且还会堵塞当前主线程，所以是开启的其他线程来运行这些耗时的线程。生产者-消费者模型的代码，后台将数据放到一个个的任务队列中，消费者进行poll轮寻任务，遇到任务了就派出任务完成任务,`生产者-消费者模型`

`执行命令的线程是一个线程，但是对多个网络请求确是多个线程同时执行`。

## redis的瓶颈是什么?

内存瓶颈和网络瓶颈是最重要的瓶颈，redis将东西放在内存中，所以要加大内存，网络瓶颈是因为数据要在网络中进行传输，所以是比较慢的。

## 如果持久化

### AOF

AOF刷盘，每次执行一个文件之后,就会将命令追加到文件中

1. 发送命令到redis
2. 执行写命令（发送到server.aof_buf缓冲区
3. 记录命令到日志

缓冲区的内容是拷贝到了内核缓冲区区里面（也就是page cache）里面，等待内核数据写入硬盘

如果AOF过大，那么就会压缩数据，（比如说按照最后一次的写入进行计算，将AOF文件日志进行压缩，（是fork出来的子进程进行重写重写这个AOF文件,后台进程是：`bg rewrite aof`）。


## 缓存击穿，缓存击穿，缓存穿透怎么解决?

redis因为数据存储在内存上（作为缓存，就有可能出现缓存相关的错误）

- 缓存雪崩: 大量缓存同一时间过期（或者 redis寄了），那么大量的数据就会请求到数据库里面，导致压力变大
- 缓存击穿: 也是缓存过期，导致压力全部到数据库里面了，（但是这个是热点数据  
- 缓存穿透：大量的数据在 redis中的数据没有，并且也不再数据库里面。那么就全部寄了。（根本不存在的东西

解决方法：

- 缓存空值和默认值，应该这个肯定是热点数据（设置一个永远无法过期的数据），这样就可以直接在redis上缓存了 
- 缓存中的数据要保证和数据库中的数据一致，那么就需要将缓存设置一个过期时间，
  - 过期时间还要设置均匀，否则你有可能某一个时间全部过期，那么这样可以缓存雪崩和缓存击穿
  - 加互斥锁，当然锁也要设置过期时间，保证有一个请求去加载数据库中的数据，（形成了缓存），并且你要设置一个过期时间，否则客户端就请求不到缓存了。
- 缓存击穿需要可以提前判断key的合法性，保证数据一定要正确，比如说手机号什么的（我瞎写的）
- 缓存预设，防止前期的缓存大量未命中
- 紧急情况，直接熔断，返回错误信息等，别吧后台的 redis 和 服务器搞寄了



