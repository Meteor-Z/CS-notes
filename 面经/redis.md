# redis

## redis是单线程的么？

redis在后台进行进行处理的时候，确实是一个线程进行相关的操作，但是后台还是有很很多其他县城，比如用一个关闭文件（缓存fush到硬盘上）的线程，AOF刷盘的线程，因为这些任务都比较慢，而且还会堵塞当前主线程，所以是开启的其他线程来运行这些耗时的线程。生产者-消费者模型的代码，后台将数据放到一个个的任务队列中，消费者进行poll轮寻任务，遇到任务了就派出任务完成任务,`生产者-消费者模型`

`执行命令的线程是一个线程，但是对多个网络请求确是多个线程同时执行`。

## redis的瓶颈

内存瓶颈和网络瓶颈是最重要的瓶颈，redis将东西放在内存中，所以要加大内存，网络瓶颈是因为数据要在网络中进行传输，所以是比较慢的。

## 如果持久化

### AOF

AOF刷盘，每次执行一个文件之后,就会将命令追加到文件中

1. 发送命令到redis
2. 执行写命令（发送到server.aof_buf缓冲区
3. 记录命令到日志

缓冲区的内容是拷贝到了内核缓冲区区里面（也就是page cache）里面，等待内核数据写入硬盘

如果AOF过大，那么就会压缩数据，（比如说按照最后一次的写入进行计算，将AOF文件日志进行压缩，（是fork出来的子进程进行重写重写这个AOF文件,后台进程是：`bg rewrite aof`）。







